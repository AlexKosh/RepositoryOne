@model List<SandBox.Models.StoreItem>


@foreach (var modelNumber in Model.Select(x => x.ItemNumber).Distinct())
{
    <div>
        <table class="table table-condensed table-bordered">
            <tr>
                <th>@modelNumber</th>
                @foreach (var size in Model.Select(x => x.Size).Distinct().OrderBy(x => x))
                {
                    <th style="text-align:center">@size</th>
                }
            </tr>
            @foreach (var color in Model.Select(x => x.Color).Distinct())
            {
                <tr>
                    <th>
                        <button class="btn btn-default">@color</button>
                    </th>
                    @{

                //Warning!: some dangerous magic detected
                int prev = Model.Select(x => x.ItemNumber).Distinct().Min();
                int curr = 0;
                int index = 1;
                bool firstNotDisplayed = true;
                SandBox.Models.StoreItem targetItem = new SandBox.Models.StoreItem();

                foreach (var stItem in Model.Where(x => x.Color == color))
                {
                    curr = stItem.Size;
                    if (Session["OrderListStore"] != null)
                    {
                        targetItem = ((List<SandBox.Models.StoreItem>)Session["OrderListStore"])
                        .FirstOrDefault(
                        x => x.ItemNumber == modelNumber
                            && x.Color == color
                            && x.Size == stItem.Size);
                    }

                    if ((curr - prev) != 2 || ((curr - prev) == 2
                        && firstNotDisplayed))
                    {
                        if (firstNotDisplayed && curr - Model.Select(x => x.Size).Min() == 2
                            || firstNotDisplayed && curr - Model.Select(x => x.Size).Min() >= 4)
                        {
                            <td></td>
                        }

                        int emptyTdCount = ((curr - prev) / 2) - 1;
                        for (int i = 0; i < emptyTdCount; i++)
                        {
                            <td></td>
                        }

                        if (targetItem != null)
                        {
                            <td style="text-align:center">
                                @Html.ActionLink(string.Format("{0}/{1}", (stItem.Quantity - targetItem.Quantity),
                                ((SandBox.Models.ItemVM<SandBox.Models.WarehouseItem>)Session["dbModelWarehouse"])
                                .itemsList[modelNumber].Find(x => x.Color == color && x.Size == stItem.Size)
                                .Quantity),
                                                 "PickItem",
                                                  new
                                                  {
                                                      model = modelNumber,
                                                      color = color,
                                                      size = stItem.Size,
                                                      amount = stItem.Quantity - targetItem.Quantity
                                                  },
                                                 new { @class = "btn btn-default" })
                            </td>
                        }
                        else
                        {
                            <td style="text-align:center">
                                @Html.ActionLink(string.Format("{0}/{1}", stItem.Quantity,
                                  ((SandBox.Models.ItemVM<SandBox.Models.WarehouseItem>)Session["dbModelWarehouse"])
                                .itemsList[modelNumber].Find(x => x.Color == color && x.Size == stItem.Size)
                                .Quantity),
                                                 "PickItem",
                                                  new
                                                  {
                                                      model = modelNumber,
                                                      color = color,
                                                      size = stItem.Size,
                                                      amount = stItem.Quantity
                                                  },
                                                 new { @class = "btn btn-default" })
                            </td>
                        }


                        firstNotDisplayed = false;
                    }
                    else
                    {
                        if (targetItem != null)
                        {
                            <td style="text-align:center">
                                @Html.ActionLink(string.Format("{0}/{1}", (stItem.Quantity - targetItem.Quantity),
                                  ((SandBox.Models.ItemVM<SandBox.Models.WarehouseItem>)Session["dbModelWarehouse"])
                                .itemsList[modelNumber].Find(x => x.Color == color && x.Size == stItem.Size)
                                .Quantity),
                                "PickItem",
                                 new
                                 {
                                     model = modelNumber,
                                     color = color,
                                     size = stItem.Size,
                                     amount = stItem.Quantity - targetItem.Quantity
                                 },
                                new { @class = "btn btn-default" })
                            </td>
                        }
                        else
                        {
                            <td style="text-align:center">
                                @Html.ActionLink(string.Format("{0}/{1}", stItem.Quantity,
                                  ((SandBox.Models.ItemVM<SandBox.Models.WarehouseItem>)Session["dbModelWarehouse"])
                                .itemsList[modelNumber].Find(x => x.Color == color && x.Size == stItem.Size)
                                .Quantity), "PickItem",
                                 new
                                 {
                                     model = modelNumber,
                                     color = color,
                                     size = stItem.Size,
                                     amount = stItem.Quantity
                                 },
                                new { @class = "btn btn-default" })
                            </td>
                        }
                        firstNotDisplayed = false;
                    }

                    prev = curr;
                    index++;
                }
                    }
                </tr>
            }
        </table>

    </div>
}